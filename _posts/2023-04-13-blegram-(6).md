---
layout: post
title: blegram (6) - ë‹¤ì¤‘ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì¼€ë£¨ì…€
author: admin
date: 2023-04-13 23:07:00 +900
lastmod: 2023-04-13 23:07:00 +900
sitemap:
  changefreq: monthly
  priority: 0.5
categories: [Project, blegram]
tags: [blegram, Next.js, TypeScript, AWS-S3, presingedURL, react-slick]
---

> í•´ë‹¹ í”„ë¡œì íŠ¸ëŠ” `Next.js` + `TypeScript`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“œëŠ” ì¸ìŠ¤íƒ€ê·¸ë¨ í´ë¡  ê°œì¸ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.<br />
{:.prompt-info}

> `AWS-S3`ë¥¼ ì´ìš©í•œ ê²Œì‹œê¸€ì˜ ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ëŠ” ë¡œì§ì— ëŒ€í•œ í¬ìŠ¤í„°ì…ë‹ˆë‹¤.<br />ìì„¸í•œ ë¶€ë¶„ì€ [ì´ë¯¸ì§€ ì—…ë¡œë“œ - (4)](/posts/blegram-(4)){:target="_blank"}ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”!<br />
{:.prompt-info}

> íƒ€ì…ê³¼ ì½”ë“œë“¤ì„ ê°ê° ëª¨ë‘ íŒŒì¼ì„ ë¶„ë¦¬í•´ì„œ ì‘ì„±í–ˆê¸° ë•Œë¬¸ì— ì¼ë¶€ë¶„ë§Œ ê°€ì ¸ì˜¨ ê°„ì†Œí™”ëœ ì½”ë“œì…ë‹ˆë‹¤.<br />
{:.prompt-tip}

ì´ë¯¸ì§€ ì—…ë¡œë“œì˜ ì „ì²´ì ì¸ ë¡œì§ì€ ì´ì „ í¬ìŠ¤íŠ¸ì¸ [ë‹¨ì¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ](/posts/blegram-(4)){:target="_blank"}ì˜ íë¦„ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³  ë³‘ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒ ì´ì™¸ì—ëŠ” í¬ê²Œ ë‹¤ë¥¸ ë¶€ë¶„ì€ ì—†ìŠµë‹ˆë‹¤.<br />

# ğŸ“¤ FE

+ ë‹¤ì¤‘ ì´ë¯¸ì§€ ì²˜ë¦¬ íë¦„
  1. `<input type="file" accept="image/*" multiple />`ë¡œ ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì…ë ¥ë°›ìŒ
  2. `<input />`ì˜ `onChange()`ë¡œ ì…ë ¥ëœ ì´ë¯¸ì§€ë“¤ì˜ í”„ë¦¬ë·° ìƒì„± ( [window.URL.createObjectURL()](https://developer.mozilla.org/ko/docs/Web/API/URL/createObjectURL){:target="_blank"} )
  3. í”„ë¦¬ë·°ë“¤ì„ ì´ìš©í•´ì„œ `Carousel` ìƒì„±
  4. ê²Œì‹œê¸€ ìƒì„± í´ë¦­ ì‹œ `presignedURL`ì„ ì´ìš©í•´ì„œ `AWS-S3`ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
  5. ìƒì„±ëœ ì´ë¯¸ì§€ì˜ `URL` ì„œë²„ì— ì „ë‹¬ í›„ `DB`ì— ë“±ë¡ ( `|`ë¥¼ êµ¬ë¶„ìë¡œ í•´ì„œ ë¬¸ìì—´ì„ í•©ì³ì„œ ë„£ìŒ )

## 0ï¸âƒ£ Preview
> `Carousel`ì— ëŒ€í•œ ë‚´ìš©ì€ [ì—¬ê¸°](/posts/blegram-story/#-carousel-ì»´í¬ë„ŒíŠ¸){:target="_blank"}ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.<br />
{:.prompt-info}

`<input type="file" accept="image/*" multiple />`ì„ í†µí•´ ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì…ë ¥ë°›ê³  `onChange`ì™€ `window.URL.createObjectURL()`ë¥¼ ì´ìš©í•´ì„œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ìš© `URL`ì„ ìƒì„±í•©ë‹ˆë‹¤.<br />
ì¶”ê°€ì ìœ¼ë¡œ ìƒìœ„ì—ì„œ ë‚´ë ¤ì¤€ `setPhotos()`ë¥¼ ì´ìš©í•´ì„œ ì´ë¯¸ì§€ë“¤(`FileList`)ì„ `state`ì— ë“±ë¡í•˜ê³  ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.<br />

ê·¸ë¦¬ê³  [`react-slick`](https://react-slick.neostack.com){:target="_blank"}ì„ ì´ìš©í•´ì„œ í”„ë¦¬ë·°ë¡œ ì´ë¯¸ì§€ ìºë£¨ì…€ì„ ë Œë”ë§í•©ë‹ˆë‹¤.<br />
í•´ë‹¹ ë¶€ë¶„ì€ [`<Carousel />`](/posts/blegram-story/#-carousel-ì»´í¬ë„ŒíŠ¸){:target="_blank"}ì´ë¼ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì–´ì„œ ë‚´ë¶€ì—ì„œ `react-slick`ì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br />

ì¼ë‹¨ì€ ë¸Œë¼ìš°ì € ì‚¬ì´ì¦ˆì— ë§ê²Œ ë°˜ì‘í•˜ê¸° ìœ„í•´ì„œ `width`ë‘ `height`ë¥¼ ë°›ì•„ì„œ ê³ ì •ì ìœ¼ë¡œ ì‚¬ì´ì¦ˆë¥¼ ì§€ì •í•˜ëŠ” í˜•íƒœë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.<br />
( ìƒìœ„ì—ì„œëŠ” ë¸Œë¼ìš°ì € ì‚¬ì´ì¦ˆë¥¼ ê¸°ë°˜ìœ¼ë¡œ `width`, `height`ë¥¼ ê²°ì •í•©ë‹ˆë‹¤. )<br />
( ì´ ë¶€ë¶„ì—ì„œ ì“¸ëª¨ì—†ëŠ” ì´ë²¤íŠ¸ê°€ ë„ˆë¬´ ë§ì´ ì‹¤í–‰ë¼ì„œ ì„±ëŠ¥ì— ë¬¸ì œê°€ ìˆì„ê¹Œ ê±±ì •ì´ ë˜ê¸´ í•©ë‹ˆë‹¤... ğŸ¥² )<br />

+ [`/src/components/common/FormToolkit/MultiPhotoInput/index.tsx`](https://github.com/1-blue/blegram/tree/master/src/components/common/FormToolkit/MultiPhotoInput/index.tsx){:target="_blank"}

```tsx
import { useCallback, useEffect, useRef, useState } from "react";

// component
import Icon from "@src/components/common/Icon";
import Carousel from "@src/components/common/Carousel";

// style
import StyledMultiPhoto from "./style";

// type
interface Props {
  setPhotos: React.Dispatch<React.SetStateAction<FileList | null>>;
}

/** 2023/04/08 - ë‹¤ì¤‘ ì´ë¯¸ì§€ ì…ë ¥ë°›ëŠ” ì¸í’‹ ì»´í¬ë„ŒíŠ¸ - by 1-blue */
const MultiPhotoInput: React.FC<Props> = ({ setPhotos }) => {
  /** 2023/04/08 - ì´ë¯¸ì§€ ref - by 1-blue */
  const photoRef = useRef<null | HTMLInputElement>(null);
  /** 2023/04/08 - ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° - by 1-blue */
  const [previewPhotos, setPreviewPhotos] = useState<string[]>([]);

  /** 2023/04/08 - ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë“±ë¡ - by 1-blue */
  const onUploadPreview: React.ChangeEventHandler<HTMLInputElement> =
    useCallback(
      (e) => {
        setPhotos(e.target.files);

        // ì´ë¯¸ í”„ë¦¬ë·°ê°€ ìˆë‹¤ë©´ ì œê±° ( GCì—ê²Œ ëª…ë ¹ )
        if (previewPhotos.length !== 0) {
          previewPhotos.map((previewPhoto) =>
            URL.revokeObjectURL(previewPhoto)
          );
        }

        // ì¸ë„¤ì¼ì´ ì…ë ¥ë˜ë©´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ë³´ì—¬ì¤„ ìˆ˜ ìˆë„ë¡ blob url ì–»ê¸°
        if (e.target.files && e.target.files.length > 0) {
          setPreviewPhotos(
            [...e.target.files].map((file) => URL.createObjectURL(file))
          );
        }
      },
      [previewPhotos, setPhotos]
    );
  /** 2023/04/08 - ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì—…ë¡œë“œí•˜ë©´ Blob í• ë‹¹ í•´ì œ - by 1-blue */
  useEffect(() => {
    if (!photoRef.current) return;

    photoRef.current.onload = () => {
      previewPhotos.map((previewPhoto) => URL.revokeObjectURL(previewPhoto));
    };
  }, [previewPhotos]);

  return (
    <StyledMultiPhoto>
      {/* ì´ë¯¸ì§€ ì…ë ¥ë°›ëŠ” ì¸í’‹ */}
      <input
        type="file"
        accept="image/*"
        hidden
        ref={photoRef}
        onChange={onUploadPreview}
        multiple
      />

      {/* preview || ì´ë¯¸ì§€ */}
      <figure>
        <Carousel photos={previewPhotos} />

        {previewPhotos.length === 0 && <Icon shape={"photo"} size="xl" fill />}

        {/* ë§ˆìš°ìŠ¤ hover ì‹œ ë³´ì—¬ì¤„ fg */}
        {previewPhotos.length === 0 && (
          <button type="button" onClick={() => photoRef.current?.click()}>
            <Icon shape={"photo"} size="2xl" fill />
          </button>
        )}
      </figure>
    </StyledMultiPhoto>
  );
};

export default MultiPhotoInput;
```

## 1ï¸âƒ£ ë‹¤ì¤‘ ì´ë¯¸ì§€ ì—…ë¡œë“œ
> ëª¨ë“  ë¡œì§ì„ ë‹¤ ì ê¸°ì—ëŠ” ë„ˆë¬´ ë§ê¸° ë•Œë¬¸ì— ìƒì„¸í•œ íƒ€ì…ê³¼ ë©”ì„œë“œë“¤ì€ ê¹ƒí—™ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”!<br />
{:.prompt-info}

ì•„ë˜ì˜ `setPhotos()`ë¥¼ í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ì— ë‚´ë ¤ì£¼ê³  ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì •í•´ì§„ ë¡œì§ì„ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.<br />

1. `presignedURL`ë“¤ ê°€ì ¸ì˜¤ê¸°
2. `AWS-S3`ì— ì´ë¯¸ì§€ë“¤ ì—…ë¡œë“œ
3. ë°±ì—”ë“œì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ì˜ `URL` ì „ì†¡

+ [`/src/app/upload/page.tsx`](https://github.com/1-blue/blegram/tree/master/src/app/upload/page.tsx){:target="_blank"}

```tsx
const PostUploadPage = () => {
  /** 2023/04/08 - ì´ë¯¸ì§€ input value - by 1-blue */
  const [photos, setPhotos] = useState<null | FileList>(null);

  /** 2023/04/08 - ê²Œì‹œê¸€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ - by 1-blue */
  const onUploadPost: React.FormEventHandler<HTMLFormElement> = handleSubmit(
    useCallback(
      async ({ contents }) => {
        if (!photos?.length) return toast.warning("ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!");

        try {
          setIsUploadPost(true);

          // "presignedURL"ë“¤ ìƒì„± ë° ê°€ì ¸ì˜¤ê¸°
          const { presignedURLs } =
            await apiServicePhotos.apiFetchPresignedURLs({
              names: [...photos].map((photo) => photo.name),
            });

          // "AWS-S3"ì— ì´ë¯¸ì§€ë“¤ ë“±ë¡
          await Promise.all(
            presignedURLs.map((presignedURL, i) =>
              apiServicePhoto.apiUploadPhoto({ presignedURL, file: photos[i] })
            )
          );

          // ì™„ì„±ë  ì´ë¯¸ì§€ ê²½ë¡œë“¤ ì–»ê¸°
          const photoPaths = presignedURLs.map((presignedURL) =>
            presignedURL
              .slice(0, presignedURL.indexOf("?"))
              .slice(presignedURL.indexOf(process.env.NODE_ENV))
          );

          // ê²Œì‹œê¸€ ì—…ë¡œë“œ
          uploadPostMudate({ contents, photoPaths });
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ì—…ë¡œë“œ ì—ëŸ¬ >> ", error);
        } finally {
          setIsUploadPost(false);
        }
      },
      [photos, uploadPostMudate]
    )
  );

  return (
    <>
      <div>
        <span>ì´ë¯¸ì§€ ë“±ë¡</span>
        <FormToolkit.MultiPhotoInput
          width={width}
          height={width * 0.8}
          alt="ê²Œì‹œê¸€ì— ë“±ë¡í•  ì´ë¯¸ì§€"
          setPhotos={setPhotos}
        />
      </div>
    </>
  )
}

export default PostUploadPage;
```

# ğŸ“¥ BE
ì´ë¯¸ì§€ë“¤ì„ `DB`ì— ë“±ë¡í•˜ëŠ” ë¡œì§ì€ ê·¸ëƒ¥ `prisma`ë¡œ ê²Œì‹œê¸€ ìƒì„±í•  ë•Œ `URL`ì„ ë„£ëŠ” ë‹¨ìˆœí•œ ë¶€ë¶„ë°–ì— ì—†ì–´ì„œ ì œì™¸í•˜ê² ìŠµë‹ˆë‹¤.<br />

## 0ï¸âƒ£ presignedURLë“¤ ìƒì„±
í”„ë¡ íŠ¸ë¡œë¶€í„° ë°›ì€ ì´ë¯¸ì§€ì˜ `name`ë“¤ì„ ì´ìš©í•´ì„œ `presignedURL`ë“¤ì„ ìƒì„±í•˜ê³  ê·¸ `URL`ì„ í”„ë¡ íŠ¸ë¡œ ì „ì†¡í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ì…ë‹ˆë‹¤.<br />

+ [`/src/pages/api/photos.ts`](https://github.com/1-blue/blegram/tree/master/src/pages/api/photos.ts){:target="_blank"}

```ts
// aws
import { getPresignedURL } from "@src/aws";

// lib
import withAuthMiddleware from "@src/lib/middleware";

// type
import type { NextApiHandler } from "next";
import type {
  ApiFetchPresignedURLsRequest,
  ApiFetchPresignedURLsResponse,
  ApiResponse,
} from "@src/types/api";

interface MyResponseType
  extends Partial<ApiFetchPresignedURLsResponse>,
    ApiResponse {}

/** 2023/04/08 - "AWS-S3"ì— ì´ë¯¸ì§€ë“¤ ìƒì„± ìš”ì²­ ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ - by 1-blue */
const handler: NextApiHandler<MyResponseType> = async (req, res) => {
  try {
    // "presignedURL"ë“¤ ìš”ì²­
    if (req.method === "POST") {
      const { names } = req.body as ApiFetchPresignedURLsRequest;

      const results = await Promise.all(
        names.map((name) => getPresignedURL({ name }))
      );

      const presignedURLs = results.map((v) => v.presignedURL);

      return res
        .status(200)
        .json({ message: "presignedURLë“¤ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.", presignedURLs });
    }
  } catch (error) {
    console.error("/api/photo error >> ", error);

    return res
      .status(500)
      .json({ message: "ì„œë²„ì¸¡ ë¬¸ì œì…ë‹ˆë‹¤.\nì ì‹œí›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!" });
  }
};

export default withAuthMiddleware({
  methods: ["POST"],
  handler,
  isAuth: true,
});
```

# ğŸ“® ë ˆí¼ëŸ°ìŠ¤
1. [window.URL.createObjectURL()](https://developer.mozilla.org/ko/docs/Web/API/URL/createObjectURL){:target="_blank"}
1. [1-blue - Carousel](/posts/blegram-story/#-carousel-ì»´í¬ë„ŒíŠ¸){:target="_blank"}

1. [1-blue - ì´ë¯¸ì§€ ì—…ë¡œë“œ - (4)](/posts/blegram-(4)){:target="_blank"}