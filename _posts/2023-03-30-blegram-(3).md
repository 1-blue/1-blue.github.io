---
layout: post
title: blegram(3) - ë°ì´í„° íŒ¨ì¹­ ( react-query )
author: admin
date: 2023-03-30 19:54:00 +900
lastmod: 2023-03-30 19:54:00 +900
sitemap:
  changefreq: monthly
  priority: 0.5
categories: [Project, blegram]
tags: [blegram, Next.js, TypeScript, react-query]
---

> í•´ë‹¹ í”„ë¡œì íŠ¸ëŠ” `Next.js` + `TypeScript`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“œëŠ” ì¸ìŠ¤íƒ€ê·¸ë¨ í´ë¡  ê°œì¸ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.<br />
{:.prompt-info}

> í•´ë‹¹ í¬ìŠ¤íŠ¸ëŠ” í”„ë¡œì íŠ¸ì—ì„œ `react-query`ë¥¼ ì‚¬ìš©í•œ ëª‡ ê°€ì§€ ë°©ë²•ì— ëŒ€í•´ ì •ë¦¬í•˜ëŠ” í¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.<br />ê°œë°œì„ ì§„í–‰í•˜ë©´ì„œ ì‘ì„±ëœ ë‚´ìš©ì´ ìˆ˜ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br />
{:.prompt-tip}

# ğŸ¦´ ì„¸íŒ…
`react-query`ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `provider`ë¥¼ ë“±ë¡í•˜ë©´ì„œ ì„±ê³µê³¼ ì‹¤íŒ¨ì— ëŒ€í•œ í•¸ë“¤ëŸ¬ë¥¼ ë“±ë¡í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.<br />
êµ¬ì²´ì ì¸ ì„±ê³µ/ì‹¤íŒ¨ í•¸ë“¤ëŸ¬ê°€ ë“±ë¡ë˜ì–´ìˆì§€ ì•Šë‹¤ë©´ ì „ì—­ì ìœ¼ë¡œ ë“±ë¡í•œ í•¸ë“¤ëŸ¬ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.<br />

+ [`/src/providers/MyReactQueryProvider.tsx`](https://github.com/1-blue/blegram/tree/master/src/providers/MyReactQueryProvider.tsx){:target="_blank"}

```tsx
import { AxiosError } from "axios";
import { QueryClientProvider, QueryClient } from "react-query";
import { ReactQueryDevtools } from "react-query/devtools";
import { toast } from "react-toastify";

/** 2023/03/30 - ì—ëŸ¬ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ - by 1-blue */
const queryErrorHandler = (error: unknown) => {
  let message = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";

  if (error instanceof AxiosError) {
    message = error.response?.data.message;
  } else if (error instanceof Error) {
    message = error.message;
  }

  toast.warning(message);
};

/** 2023/03/30 - ì„±ê³µ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ - by 1-blue */
const querySuccessHandler = (data: unknown) => {
  if (
    typeof data === "object" &&
    data &&
    "message" in data &&
    typeof data.message === "string"
  ) {
    toast.success(data.message);
  }
};

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      onError: queryErrorHandler,
      onSuccess: querySuccessHandler,
      staleTime: 1000 * 60 * 15, // 15 ë¶„
      cacheTime: 1000 * 60 * 10, // 10 ë¶„
    },
    mutations: {
      onError: queryErrorHandler,
      onSuccess: querySuccessHandler,
    },
  },
});

/** 2023/03/26 - "react-query" Provider ì ìš© - by 1-blue */
const MyReactQueryProvider: React.FC<React.PropsWithChildren> = ({
  children,
}) => (
  <QueryClientProvider client={queryClient}>
    <ReactQueryDevtools initialIsOpen position="top-left" />
    {children}
  </QueryClientProvider>
);

export default MyReactQueryProvider;
```

# ğŸ–Œï¸ Custom Hook
> êµ¬ì²´ì ì¸ `type`ê³¼ `api` ìš”ì²­ ë©”ì„œë“œë“¤ì€ ì‘ì„±í•˜ê¸°ì—ëŠ” ìë¦¬ë¥¼ ë§ì´ ì°¨ì§€í•´ì„œ [GitHub](https://github.com/1-blue/blegram/tree/master/src/hooks){:target="_blank"}ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”!<br />
{:.prompt-tip}

`useQuery()`ì—ì„œ `key`ë¡œ ë„£ì–´ì¤„ ì¸ìë¡œ ì‚¬ìš©í•  ê°’ì…ë‹ˆë‹¤.<br />

ì¿¼ë¦¬ ë¬´íš¨í™”ë¥¼ í•˜ëŠ” ê²½ìš° ì ‘ë‘ì‚¬ê°€ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  ì¿¼ë¦¬ë¥¼ ê°™ì´ ë¬´íš¨í™”í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê°™ì€ ì´ë¦„ì˜ ë³€ìˆ˜ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë”°ë¡œ ë¶„ë¦¬í•´ì„œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.<br />

+ [`/src/hooks/query/index.ts`](https://github.com/1-blue/blegram/tree/master/src/hooks/query/index.ts){:target="_blank"}

```ts
/** 2023/03/30 - "react-query"ì˜ key - by 1-blue */
export const queryKeys = {
  user: "user",
};
```

## 0ï¸âƒ£ GETì„ ì‚¬ìš©í•˜ëŠ” í›…
ì¿¼ë¦¬ ë¬´íš¨í™”ì™€ ê³ ìœ í•œ í‚¤ë¥¼ ê°–ê¸° ìœ„í•´ì„œ `queryKeys.user`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.<br />
ì‘ë‹µ ì„±ê³µê³¼ ì‹¤íŒ¨ì— ëŒ€í•œ ê³µí†µëœ ì²˜ë¦¬(í† ìŠ¤íŠ¸ ë©”ì‹œì§€)ëŠ” ìœ„ì˜ [QueryClient](/posts/blegram-(3)/#-ì„¸íŒ…)ì—ì„œ ì²˜ë¦¬í•´ì¤¬ìŠµë‹ˆë‹¤.<br />
ê·¸ë¦¬ê³  ë‚˜ë¨¸ì§€ëŠ” ê°ìì˜ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.<br />

ëŒ€í‘œì ìœ¼ë¡œ ì‚¬ìš©í•œ í˜•íƒœë¡œ í•˜ë‚˜ë¥¼ ê°€ì ¸ì™”ê³  ë‚˜ë¨¸ì§€ëŠ” ìœ ì‚¬í•œ í˜•íƒœë¡œ ê³„ì† ìƒì„±í•´ì„œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br />

+ [`/src/hooks/useUser.ts`](https://github.com/1-blue/blegram/tree/master/src/hooks/useUser.ts){:target="_blank"}

```ts
import { useQuery } from "react-query";

// api
import { apiServiceUser } from "@src/apis";

// key
import { queryKeys } from ".";

// type
import type { ApiFetchUserResponse } from "@src/types/api";

interface UseUserHandler {
  (nickname: string): {
    user?: ApiFetchUserResponse["user"];
    isFetchingUser: boolean;
  };
}

/** 2023/03/29 - íŠ¹ì • ìœ ì € ì •ë³´ë¥¼ ì–»ëŠ” í›… - by 1-blue */
const useUser: UseUserHandler = (nickname) => {
  const { data, isLoading } = useQuery<ApiFetchUserResponse>(
    [queryKeys.user, nickname],
    () => apiServiceUser.apiFetchUser({ nickname })
  );

  return { user: data?.user, isFetchingUser: isLoading };
};

export default useUser;
```

## 1ï¸âƒ£ GETì„ ì œì™¸í•œ í›… ( mutate )
`POST`, `PATCH`, `DELETE` ë“±ì˜ ë©”ì„œë“œëŠ” íŠ¹ì • ì´ë²¤íŠ¸ì— ì˜í•´ì„œ ë™ì‘í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— `mutate`ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.<br />

`mutate`ëŠ” ìš”ì²­ì„ ìˆ˜ì •í•˜ëŠ” ëª©ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ì•Œê³  ìˆì–´ì„œ ë¡œê·¸ì¸ ê°™ì€ ê²½ìš°ëŠ” êµ³ì´ `react-query`ë¥¼ ê±°ì³ì„œ ìš”ì²­í•  í•„ìš”ëŠ” ì—†ì§€ë§Œ, ëª¨ë“  ì½”ë“œì˜ ì¼ê´€ì„±ì„ ìœ„í•´ì„œ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì€ `react-query`ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br />

`mutate` ë˜í•œ [QueryClient](/posts/blegram-(3)/#-ì„¸íŒ…)ì—ì„œ ì²˜ë¦¬í–ˆê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ê°€ ë Œë”ë§ë˜ê²Œ ë©ë‹ˆë‹¤.<br /> 

+ [`/src/hooks/useLogIn.ts`](https://github.com/1-blue/blegram/tree/master/src/hooks/useLogIn.ts){:target="_blank"}

```ts
import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { useMutation } from "react-query";

// api
import { apiServiceAuth } from "@src/apis";

// type
import type { UseMutateFunction } from "react-query";
import type { ApiLogInRequest, ApiLogInResponse } from "@src/types/api";

/** 2023/03/30 - ë¡œê·¸ì¸ ìš”ì²­ í›… - by 1-blue */
const useLogIn = (): UseMutateFunction<
  ApiLogInResponse,
  unknown,
  ApiLogInRequest,
  unknown
> => {
  const router = useRouter();
  const { mutate, isSuccess } = useMutation(apiServiceAuth.apiLogIn);

  /** 2023/03/30 - ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ - by 1-blue */
  useEffect(() => void (isSuccess && router.replace("/")), [isSuccess, router]);

  return mutate;
};

export default useLogIn;
```

# ğŸ“® ë ˆí¼ëŸ°ìŠ¤
1. [react-query](https://tanstack.com/query/latest){:target="_blank"}

1. [GitHib - blegram](https://github.com/1-blue/blegram){:target="_blank"}