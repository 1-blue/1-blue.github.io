---
title: prisma ( ORM )
author: admin
date: 2023-01-04 17:02:00 +900
lastmod: 2023-01-15 13:56:00 +900
sitemap:
  changefreq: monthly
  priority: 0.5
categories: [BackEnd, Prisma]
tags: [ORM, Prisma, Database]
---

> í•´ë‹¹ í¬ìŠ¤íŠ¸ëŠ” `ORM`ì¸ `prisma`ì— ëŒ€í•œ ê°œë…ê³¼ ê¸°ë³¸ì ì¸ ì‚¬ìš©ë²•ì„ ì •ë¦¬í•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.<br />
{: .prompt-info}

# ğŸ“ ìš©ì–´ ì •ë¦¬
1. `ORM`: `Object Relational Mapping`ìœ¼ë¡œ `JavaScript`ì˜ ê°ì²´ë¥¼ `DB`ì˜ `table`ê³¼ ë§µí•‘ì‹œì¼œì£¼ëŠ” ê²ƒì„ ì˜ë¯¸
2. `schema.prisma`: ì½”ë“œìƒìœ¼ë¡œ ëª¨ë¸ ìƒì„± ë° ê´€ê³„ ì„¤ì •ì„ í•˜ëŠ” íŒŒì¼
3. `draft migration file`: í˜„ì¬ ì‘ì„±ëœ `schema.prisma`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±ëœ `.sql`
4. `_prisma_migrations`: `prisma`ì—ì„œ `migrate` ê¸°ë¡ì„ í™•ì¸í•˜ê¸° ìœ„í•´ `DB`ì— ì €ì¥í•œ `table`

# âš™ï¸ ê¸°ë³¸ ì„¸íŒ…
> `mysql`ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.<br />
{: .prompt-info}

## 1. ì„¤ì¹˜
```bash
npm i prisma @prisma/client
```

ì¶”ê°€ë¡œ `VSCode`ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ `Prisma`ë¼ëŠ” Extensionì„ ì„¤ì¹˜í•˜ë©´ `schema.prisma`ì—ì„œ ëª¨ë¸ì„ ì •ì˜í•  ë•Œ ë„ì›€ì´ ë©ë‹ˆë‹¤.

## 2. ì´ˆê¸°í™”
```bash
npx prisma init
```
 
## 3. ê¸°ë³¸ ì œê³µ íŒŒì¼ ìˆ˜ì •
### 3.1 schema.prisma ìˆ˜ì •
```
generator client {
  provider = "prisma-client-js"
}

// "postgresql" -> "mysql"ë¡œ ë°”ê¾¸ê¸°
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}
```

### 3.2 .env ìˆ˜ì •
```
DATABASE_URL="mysql://<ìœ ì €ëª…>:<ë¹„ë°€ë²ˆí˜¸>@localhost:3306/<DBì´ë¦„>â€
```

# ğŸ—ƒï¸ ëª¨ë¸ ( ê´€ê³„ ì„¤ì • )
ì•„ë˜ ì˜ˆì‹œì—ì„œ 1ë²ˆì„ ê¸°ì¤€ìœ¼ë¡œ `@relation()`ì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.<br />
`fields`ëŠ” `Post`ì—ì„œ ì°¸ì¡°í•  `User`ì˜ ì‹ë³„ìì˜ ì´ë¦„ì„ ì •í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.<br />
`references`ëŠ” `Foreign Key`ë¡œ ì‚¬ìš©í•  ê²ƒì„ ì§€ì •í•©ë‹ˆë‹¤.<br />
`onUpdate`/`onDelete`ëŠ” `DB`ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒê³¼ ê°™ì€ ì˜ë¯¸ì…ë‹ˆë‹¤. ( `Cascade`ëŠ” ì°¸ì¡° ëŒ€ìƒì´ ì‚¬ë¼ì§€ë©´ ë³¸ì¸ë„ ì œê±°í•˜ë¼ëŠ” ì˜ë¯¸ì£  )<br />
`User`ì˜ `idx`ì»¬ëŸ¼ì„ `Foreign Key`ë¡œ ì‚¬ìš©í•˜ë˜ `Post`ì—ì„œëŠ” `userIdx`ë¼ê³  ë¶€ë¥´ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.<br />

## 1. ëª¨ë¸ ì •ì˜
```
model User {
  idx Int @id @default(autoincrement())

  // "User"ì™€ "Profile" ( 1 : 1 )
  profile Profile?

  // "User"ì™€ "Post" ( 1 : N )
  posts Post[]

  // "User"ì™€ "Job" ( N : M ) ( ì¤‘ê°„ í…Œì´ë¸”ì„ ì•ˆë§Œë“¤ë©´ prismaì—ì„œ ì•Œì•„ì„œ ì´ë¦„ì„ ì§€ì •í•´ì„œ ìƒì„± ( "_jobtouser"ë¼ëŠ” í…Œì´ë¸” ìƒì„± ) )
  jobs Job[]

  // "User"ì™€ "User" ( ìê¸°ì°¸ì¡° N : M ) ( ì¤‘ê°„ í…Œì´ë¸”ì„ ëª…ì‹œì ìœ¼ë¡œ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì— "follows"ë¼ëŠ” í…Œì´ë¸”ì´ ìƒì„± )
  follower Follows[] @relation("follower")
  following Follows[] @relation("following")
}

// 1 : 1
model Profile {
  idx Int @id @default(autoincrement())
  name String @db.VarChar(30)
  email String @unique @db.VarChar(50)

  // "User"ì™€ "Profile" ( 1 : 1 ) ( 1 : 1ì´ê¸° ë•Œë¬¸ì— Userì¸¡ì—ì„œ ì•„ë˜ ë‚´ìš©ì„ ì‘ì„±í•´ë„ ë©ë‹ˆë‹¤. )
  user User @relation(fields: [userIdx], references: [idx], onUpdate: Cascade, onDelete: Cascade)
  userIdx Int @unique
}

// 1 : N
model Post {
  idx Int @id @default(autoincrement())
  title String
  description String @db.VarChar(500)

  // "User"ì™€ "Post" ( 1 : N ) ( >> 1ë²ˆ << )
  user User @relation(fields: [userIdx], references: [idx], onUpdate: Cascade, onDelete: Cascade)
  userIdx Int
}

// N : M
model Job {
  idx Int @id @default(autoincrement())
  name String @db.VarChar(100)

  users User[]
}

// ìê¸°ì°¸ì¡° N : M ( ì¤‘ê°„ í…Œì´ë¸” )
model Follows {
  follower    User @relation("follower", fields: [followerIdx], references: [idx], onUpdate: Cascade, onDelete: Cascade)
  followerIdx  Int
  following   User @relation("following", fields: [followingIdx], references: [idx], onUpdate: Cascade, onDelete: Cascade)
  followingIdx Int

  @@id([followerIdx, followingIdx])
}
```

## 2. migrateë¡œ ìƒì„±ëœ SQL
```sql
-- CreateTable
CREATE TABLE `User` (
    `idx` INTEGER NOT NULL AUTO_INCREMENT,

    PRIMARY KEY (`idx`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `Profile` (
    `idx` INTEGER NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(30) NOT NULL,
    `email` VARCHAR(50) NOT NULL,
    `userIdx` INTEGER NOT NULL,

    UNIQUE INDEX `Profile_email_key`(`email`),
    UNIQUE INDEX `Profile_userIdx_key`(`userIdx`),
    PRIMARY KEY (`idx`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `Post` (
    `idx` INTEGER NOT NULL AUTO_INCREMENT,
    `title` VARCHAR(191) NOT NULL,
    `description` VARCHAR(500) NOT NULL,
    `userIdx` INTEGER NOT NULL,

    PRIMARY KEY (`idx`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `Job` (
    `idx` INTEGER NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(100) NOT NULL,

    PRIMARY KEY (`idx`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `Follows` (
    `followerIdx` INTEGER NOT NULL,
    `followingIdx` INTEGER NOT NULL,

    PRIMARY KEY (`followerIdx`, `followingIdx`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `_JobToUser` (
    `A` INTEGER NOT NULL,
    `B` INTEGER NOT NULL,

    UNIQUE INDEX `_JobToUser_AB_unique`(`A`, `B`),
    INDEX `_JobToUser_B_index`(`B`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- AddForeignKey
ALTER TABLE `Profile` ADD CONSTRAINT `Profile_userIdx_fkey` FOREIGN KEY (`userIdx`) REFERENCES `User`(`idx`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `Post` ADD CONSTRAINT `Post_userIdx_fkey` FOREIGN KEY (`userIdx`) REFERENCES `User`(`idx`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `Follows` ADD CONSTRAINT `Follows_followerIdx_fkey` FOREIGN KEY (`followerIdx`) REFERENCES `User`(`idx`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `Follows` ADD CONSTRAINT `Follows_followingIdx_fkey` FOREIGN KEY (`followingIdx`) REFERENCES `User`(`idx`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `_JobToUser` ADD CONSTRAINT `_JobToUser_A_fkey` FOREIGN KEY (`A`) REFERENCES `Job`(`idx`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `_JobToUser` ADD CONSTRAINT `_JobToUser_B_fkey` FOREIGN KEY (`B`) REFERENCES `User`(`idx`) ON DELETE CASCADE ON UPDATE CASCADE;
```

# âœï¸ ë§ˆì´ê·¸ë ˆì´ì…˜
> í•´ë‹¹ ë‚´ìš©ì€ [Prisma migrate ë¸”ë¡œê·¸](https://pyh.netlify.app/prisma/prisma_migrate){:target="_blank"}ë¥¼ ì°¸ê³ í•´ì„œ ìš”ì•½í•œ ë‚´ìš©ì´ê¸° ë•Œë¬¸ì— í•´ë‹¹ ë¸”ë¡œê·¸ë¥¼ ë³´ì‹œëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.<br />
{: .prompt-info}

ìœ„ ëª¨ë¸ì„ ê·¸ëŒ€ë¡œ ì„ ì–¸í•˜ê³  [ëª…ë ¹ì–´](/posts/prisma/#3-ëª…ë ¹ì–´)ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ë©´ì„œ ë³€í™” ê³¼ì •ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì‹œë©´ ì´í•´ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.<br />
`_prisma_migrations`ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê¸°ì¡´ì— í–ˆë˜ `migrate`ëŠ” ì‹¤í–‰í•˜ì§€ ì•Šê³  ë³€ê²½ëœ ëª…ë ¹ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.<br />

## 1. migrateë€
`DB`ì˜ `schema`(`table`)ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆëŠ” íˆ´<br />

## 2. ë™ì‘ íë¦„
1. `draft migration file` ìƒì„±
2. `draft migration file`ì„ `DB`ì˜ `schema`ì— ì ìš© ë° `_prisma_migrations`ì— ì¶”ê°€
3. `generate artifacts` ì ìš© ( ì½”ë“œìƒìœ¼ë¡œ `Type`ì´ ë§Œë“¤ì–´ì§€ê³  ì ìš©ë˜ëŠ” ê³¼ì • )

## 3. ëª…ë ¹ì–´
1. `npx prisma migrate dev --create-only`: `draft migration file`ë§Œ ìƒì„± ( ì¦‰, `/prisma/migrations/ìƒì„±ì‹œê°„_ì´ë¦„/migration.sql` ìƒì„± )
2. `npx prisma migrate deploy`: `DB`ì— ì ìš© ë° `_prisma_migrations` ì—…ë°ì´íŠ¸
3. `npx prisma generate`: `prisma client` ìƒì„± ( ì¦‰, íƒ€ì…ì„ ë§Œë“¤ê³  ì½”ë“œì— ì ìš© )
1. `npx prisma migrate dev`: ìœ„ 3ê°€ì§€ ëª…ë ¹ì–´ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ ( ì¦‰, `.sql` ë§Œë“¤ê³  `DB`ì— ì ìš©í•˜ê³  ì½”ë“œì— ì ìš© )

# ğŸ“Œ ì½”ë“œë¡œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
ì´ ë¶€ë¶„ì€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ë„ˆë¬´ ë§ì•„ì„œ ìƒëµí•˜ê² ìŠµë‹ˆë‹¤.<br />
ì•ìœ¼ë¡œ ì‚¬ìš©í•´ë³´ë©´ì„œ ì´ëŸ° ë‚´ìš©ì€ ì¶”ê°€í• ë§Œí•˜ë‹¤ë¼ê³  ëŠê»´ì§€ë©´ ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤.<br />

ğŸ˜¶<br />

# ğŸŒ± seed
ê¸°ë³¸ ë°ì´í„°ë“¤ì„ ë°ì´í„° ë² ì´ìŠ¤ì— ë„£ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.<br />

## 1. ì„¸íŒ…
```bash
# ts ì½”ë“œë¥¼ ì‹¤í–‰í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ì„¤ì¹˜í•©ë‹ˆë‹¤.
npm i ts-node
```

+ `package.json` ìˆ˜ì •

```json
{
  // ... ìƒëµ
  "prisma": {
    "seed": "npx ts-node prisma/seed/index.ts"
  },
}
```

```bash
# ì•„ë˜ ì½”ë“œë¡œ seedë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
npx prisma seed

# í˜¹ì€ ë¦¬ì…‹ì‹œí‚¤ë©´ ìë™ìœ¼ë¡œ seedê°€ ì¶”ê°€ë©ë‹ˆë‹¤. ( ë‹¨, ì´ì „ì— ë„£ì—ˆë˜ ëª¨ë“  ë°ì´í„°ê°€ ë‚ ì•„ê°€ê³  seedë§Œ ë‚¨ìŠµë‹ˆë‹¤. )
npx prisma migrate reset
```

## 2. seed ì½”ë“œ ì‘ì„± ì˜ˆì‹œ
ì•„ë˜ ì½”ë“œëŠ” [ìœ„ì˜ ì˜ˆì‹œ](/posts/prisma/#1-ëª¨ë¸-ì •ì˜)ì˜ `Profile`ì„ ì˜ˆë¡œ `seed`ë¥¼ ë§Œë“¤ì–´ë´¤ìŠµë‹ˆë‹¤.<br />
ì¦‰, 1ë²ˆ ìœ ì €ì˜ í”„ë¡œí•„ì„ 30ê°œ ë§Œë“  ê²ƒì…ë‹ˆë‹¤.<br />
ì•„ë§ˆ 1ë²ˆ ìœ ì €ê°€ ì—†ë‹¤ë©´ ì˜¤ë¥˜ê°€ ë‚˜ê² ì£ <br />

```ts
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

// type
import type { Prisma } from "@prisma/client";

// ê°€ì§œ profile 30ê°œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
const getDummyProfile = (): Prisma.ProfileCreateManyInput[] =>
  Array(30)
    .fill(null)
    .map((v, i) => ({
      name: "test" + i,
      email: "test" + i + "@naver.com",
      userIdx: 1,
    }));

async function main() {
  prisma.profile.createMany({
    skipDuplicates: true,
    data: getDummyProfile(),
  });
}

main()
  .then(async () => {
    await prisma.$disconnect();
  })
  .catch(async (e) => {
    console.error(e);
    await prisma.$disconnect();
    // process.exit(1);
  });
```

# ğŸ˜® ìœ ìš©í•œ prisma ëª…ë ¹ì–´ë“¤
1. `npx prisma studio`: `DB`ë¥¼ ì‰½ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì›¹ ë¸Œë¼ìš°ì €ë¡œ `UI` ì œê³µ ( `CRUD` ê°€ëŠ¥ )
2. `npx prisma migrate dev`: `magration` ìˆ˜í–‰
3. `npx prisma migrate reset`: ê¸°ì¡´ `DB`ì˜ ë°ì´í„° ëª¨ë‘ ì‚­ì œí•˜ê³  ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í›„ `seed` ì‹¤í–‰
4. `npx prisma db pull`: ë°ì´í„° ë² ì´ìŠ¤ì˜ í…Œì´ë¸”ì„ `prisma`ì— ì ìš©
5. `npx prisma db push`: `magration` ì—†ì´ `DB`ì— ì ìš©

# ğŸ˜¶ ì†Œì†Œí•œ íŒ
## 1. íƒ€ì…ì´ ë°”ë¡œ ì ìš© ì•ˆë˜ëŠ” ê²½ìš°
`npx prisma generate` í˜¹ì€ `npx prisma migrate dev`ë¥¼ ì‹¤í–‰í•œ í›„ íƒ€ì…ì´ ì ìš©ì´ ì•ˆëœë‹¤ë©´ prisma íƒ€ì… ì •ì˜ëœ íŒŒì¼ì— ë“¤ì–´ê°”ë‹¤ê°€ ë‹¤ì‹œ ë‚˜ì˜¤ë©´ ë©ë‹ˆë‹¤.<br />

## 2. ë§Œë“¤ì–´ì§„ íƒ€ì… ì‚¬ìš©í•˜ê¸°
`model`ì„ ìƒì„±í•˜ê³  ì ìš©í–ˆë‹¤ë©´ ê·¸ì— ë§ëŠ” íƒ€ì…ì´ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.<br />

[ìœ„ì˜ ì˜ˆì‹œ](/posts/prisma/#1-ëª¨ë¸-ì •ì˜)ì˜ `Profile`ì„ ì˜ˆë¡œ ë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.

+ ìƒì„±ëœ íƒ€ì… í˜•íƒœ

```ts
// ì´ëŸ° íƒ€ì…ì´ ìƒì„±ë˜ì—ˆê³ , "export"ê¸° ë•Œë¬¸ì— ê·¸ëŒ€ë¡œ ê°€ì ¸ë‹¤ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.
export type Profile = {
  idx: number
  name: string
  email: string
  userIdx: number
}
```

+ íƒ€ì… ìˆ˜ì • ë°©ë²•

```ts
// í˜¹ì‹œ íƒ€ì…ì„ ì“°ë‹¤ê°€ íƒ€ì…ì„ ì¡°ê¸ˆì”© ë°”ê¿”ì„œ ì“°ê³  ì‹¶ë‹¤ë©´ typescript utilityë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.
import type { Profile } from "@prisma/client";

// ë§Œì•½ userIdxë¥¼ ì•ˆ ë°›ëŠ”ë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•´ì„œ ì‚¬ìš©í•˜ë©´ ë˜ê² ì£ 
// ê·¸ëŸ¬ë©´ Proflie ìì²´ë¥¼ ìˆ˜ì •í•˜ë”ë¼ë„ ì•„ë˜ íƒ€ì…ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. êµ³ì´ ìˆ˜ì •í•  í•„ìš”ê°€ ì—†ì–´ì§€ì£ 
export type SimpleProfile = Omit<Profile, "userIdx">;
```

+ `express` ì‚¬ìš© ì˜ˆì‹œ

```ts
import express from "express";

// type
import type { Request, Response, NextFunction } from "express";
import type { Profile } from "@prisma/client";

router.get(
  "/",
  async (
    req: Request<{}, {}, {}, { name: string }>,
    res: Response<{ message: string; profile: Profile }>,
    next: NextFunction
  ) => {
    try {
      const { name } = req.query;

      const profile = await prisma.profile.findFirst({ name });

      return res.json({
        message: `"${name}"ë‹˜ì˜ í”„ë¡œí•„ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`,
        profile
      });
    } catch (error) {
      next(error);
    }
  }
);
```

# ğŸ“® ë ˆí¼ëŸ°ìŠ¤
1. [Prisma migrate - ë¸”ë¡œê·¸](https://pyh.netlify.app/prisma/prisma_migrate){:target="_blank"}
2. [prisma ê³µì‹ ë¬¸ì„œ - Relations](https://www.prisma.io/docs/concepts/components/prisma-schema/relations){:target="_blank"}