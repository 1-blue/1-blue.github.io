---
layout: post
title: blegram (5) - ë¬´í•œ ìŠ¤í¬ë¡¤ë§ ( react-query )
author: admin
date: 2023-04-11 19:58:00 +900
lastmod: 2023-04-11 19:58:00 +900
sitemap:
  changefreq: monthly
  priority: 0.5
categories: [Project, blegram]
tags: [blegram, Next.js, TypeScript, react-query, useInfiniteQuery, InterectionObserver API, ë¬´í•œ ìŠ¤í¬ë¡¤ë§]
---

> í•´ë‹¹ í”„ë¡œì íŠ¸ëŠ” `Next.js` + `TypeScript`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“œëŠ” ì¸ìŠ¤íƒ€ê·¸ë¨ í´ë¡  ê°œì¸ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.<br />
{:.prompt-info}

> `react-query`ì™€ `InterectionObserver API`ë¥¼ ì´ìš©í•œ ê²Œì‹œê¸€ ë¬´í•œ ìŠ¤í¬ë¡¤ë§ì— ëŒ€í•œ í¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.<br />
{:.prompt-info}

> íƒ€ì…ê³¼ ì½”ë“œë“¤ì„ ê°ê° ëª¨ë‘ íŒŒì¼ì„ ë¶„ë¦¬í•´ì„œ ì‘ì„±í–ˆê¸° ë•Œë¬¸ì— ì¼ë¶€ë¶„ë§Œ ê°€ì ¸ì˜¨ ê°„ì†Œí™”ëœ ì½”ë“œì…ë‹ˆë‹¤.<br />
{:.prompt-tip}

# ğŸ“ƒ ì†¡/ìˆ˜ì‹  ë°ì´í„° íƒ€ì…
ë¬´í•œ ìŠ¤í¬ë¡¤ë§ì„ ì ìš©í•˜ëŠ” ê²Œì‹œê¸€ì˜ ì†¡/ìˆ˜ì‹  ë°ì´í„° íƒ€ì…ì…ë‹ˆë‹¤.<br />

+ `take`: ê°€ì ¸ì˜¬ ê²Œì‹œê¸€ ê°œìˆ˜
+ `lastIdx`: ê°€ì ¸ì˜¨ ë§ˆì§€ë§‰ ê²Œì‹œê¸€ì˜ ì‹ë³„ì ( ê¸°ë³¸ ê°’: `-1` )

+ [`/src/types/api/posts.ts`](https://github.com/1-blue/blegram/tree/master/src/types/api/posts.ts){:target="_blank"}

```ts
type Post = {
  idx: number
  contents: string
  photos: string
  createdAt: Date
  updatedAt: Date
  userIdx: number
}

interface PostWithData extends Post {
  user: SimpleUser;
  comments: Comment[];
  postLiker: { postLiker: SimpleUser }[];
  _count: {
    comments: number;
    postLiker: number;
  };
}

type ApiResponse<T = unknown> = { message: string } & T;

/** 2023/04/08 - ê²Œì‹œê¸€ë“¤ ê°€ì ¸ì˜¤ê¸° ìš”ì²­ ì†¡ì‹  íƒ€ì… - by 1-blue */
export interface ApiFetchPostsRequest {
  take: number;
  lastIdx: number;
}
/** 2023/04/08 - ê²Œì‹œê¸€ë“¤ ê°€ì ¸ì˜¤ê¸° ìš”ì²­ ìˆ˜ì‹  íƒ€ì… - by 1-blue */
export interface ApiFetchPostsResponse extends ApiResponse {
  posts?: PostWithData[];
}
/** 2023/04/08 - ê²Œì‹œê¸€ë“¤ ê°€ì ¸ì˜¤ê¸° ìš”ì²­ í•¸ë“¤ëŸ¬ - by 1-blue */
export interface ApiFetchPostsHandler {
  (body: ApiFetchPostsRequest): Promise<ApiFetchPostsResponse>;
}
```

# ğŸ“¤ FE
## 0ï¸âƒ£ useInfiniteQuery
> TODO: `react-query`ì— ëŒ€í•œ ê²Œì‹œê¸€ ì‘ì„± í›„ ë§í¬ ì¶”ê°€
{:.prompt-info}

`react-query`ì˜ `useInfiniteQuery()`ë¥¼ ì´ìš©í•´ì„œ ë¬´í•œ ìŠ¤í¬ë¡¤ë§ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.<br />
( `useInfiniteQuery()`ì˜ êµ¬ì²´ì ì¸ ì‚¬ìš©ë²•ì— ëŒ€í•œ ë‚´ìš©ì€ ìƒëµí•˜ê² ìŠµë‹ˆë‹¤. )<br />

+ `take`: í•œ ë²ˆì— ë°›ì•„ì˜¬ ê²Œì‹œê¸€ì˜ ê°œìˆ˜
+ `lastIdx`: ê°€ì¥ ìµœê·¼ì— ê°€ì ¸ì˜¨ ë§ˆì§€ë§‰ ê²Œì‹œê¸€ì˜ ì‹ë³„ì ( ê¸°ë³¸ ê°’: `-1` )

+ [`/src/hooks/query/usePosts.tsx`](https://github.com/1-blue/blegram/tree/master/src/hooks/query/usePosts.tsx){:target="_blank"}

```ts
import { useInfiniteQuery } from "react-query";

// api
import { apiServicePosts } from "@src/apis";

// key
import { queryKeys } from ".";

// type
import type { ApiFetchPostsResponse } from "@src/types/api";
interface Props {
  take: number;
  targetIdx?: number;
}

/** 2023/04/08 - ê²Œì‹œê¸€ë“¤ì„ ì–»ëŠ” í›… - by 1-blue ( 2023/04/10 ) */
const usePosts = ({ take, targetIdx = -1 }: Props) => {
  const { data, fetchNextPage, hasNextPage } =
    useInfiniteQuery<ApiFetchPostsResponse>(
      queryKeys.post,
      ({ pageParam = targetIdx }) => apiServicePosts.apiFetchPosts({ take, lastIdx: pageParam }),
      {
        getNextPageParam: (lastPage, allPage) =>
          lastPage.posts?.length === take ? lastPage.posts[lastPage.posts.length - 1].idx : null,
      }
    );

  return { data, fetchNextPage, hasNextPage };
};

export default usePosts;
```

## 1ï¸âƒ£ ë Œë”ë§
ê¸°ë³¸ì ìœ¼ë¡œ `-1`ì„ ê°’ìœ¼ë¡œ ì¤˜ì„œ ê°€ì¥ ìµœì‹  ë°ì´í„°ë¶€í„° ê°€ì ¸ì˜µë‹ˆë‹¤.<br />
í•˜ì§€ë§Œ `query string`ì´ ìˆë‹¤ë©´ í•´ë‹¹ ê²Œì‹œê¸€ë¶€í„° ë¶ˆëŸ¬ì˜¤ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.<br />
( ì›ë˜ëŠ” ì–‘ë°©í–¥ ìŠ¤í¬ë¡¤ì„ êµ¬í˜„í•˜ë ¤ê³  í–ˆì§€ë§Œ, ê²Œì‹œê¸€ì„ íŠ¹ì • ì‹ë³„ì ë’¤ì—ì„œë¶€í„° ë¶ˆëŸ¬ì˜¤ëŠ” ë°©ë²•ì„ ëª» ì°¾ì•„ì„œ ì¼ë‹¨ ë„˜ì–´ê°€ê³  ì´í›„ì— ì—¬ìœ ê°€ ìˆì„ ë•Œ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤.. ğŸ¥² )<br />

`data.pages`ì— ë°°ì—´í˜•íƒœë¡œ ê²Œì‹œê¸€ë“¤ì˜ í˜ì´ì§€ ë°ì´í„°ê°€ ë“¤ì–´ê°€ìˆìŠµë‹ˆë‹¤.<br />
ê·¸ë¦¬ê³  `page.posts`ì— ë°°ì—´í˜•íƒœë¡œ ê²Œì‹œê¸€ë“¤ì˜ ë°ì´í„°ê°€ ë“¤ì–´ìˆê¸° ë•Œë¬¸ì— ë‘ ë²ˆì˜ `Array.prototype.map()`ì„ ì´ìš©í•´ì„œ ëª¨ë“  ê²Œì‹œê¸€ì„ ë Œë”ë§í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.<br />

`<InfiniteScrollContainer>`ì— ëŒ€í•´ì„œëŠ” ë°”ë¡œ ë‹¤ìŒì— ìì„¸í•˜ê²Œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.<br />
ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•˜ìë©´ í˜ì´ì§€ì˜ ìµœí•˜ë‹¨ì— ë„ì°©í•˜ë©´ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ íŒ¨ì¹­í•˜ëŠ” `HOC`ì…ë‹ˆë‹¤.<br />

+ [`/src/components/Post/index.tsx`](https://github.com/1-blue/blegram/tree/master/src/components/Post/index.tsx){:target="_blank"}

```tsx
import { useSearchParams } from "next/navigation";

// util
import { splitPhotoURL } from "@src/utils";

// hook
import usePosts from "@src/hooks/query/usePosts";

// component
import InfiniteScrollContainer from "@src/components/common/InfiniteScrollContainer";
import PostHeader from "@src/components/Post/PostHeader";
import PostPhotos from "@src/components/Post/PostPhotos";
import PostFooter from "@src/components/Post/PostFooter";

// style
import StyledPost from "./style";

/** 2023/04/09 - ê²Œì‹œê¸€ ì»´í¬ë„ŒíŠ¸ - by 1-blue */
const Post = () => {
  /** FIXME: ì–‘ë°©í–¥ ìŠ¤í¬ë¡¤ë§ìœ¼ë¡œ ë³€ê²½í•˜ê¸° */
  const searchParams = useSearchParams();
  const postIdx = searchParams?.get("postIdx");

  /** 2023/04/10 - ë¬´í•œ ìŠ¤í¬ë¡¤ë§ì„ ì ìš©í•œ ê²Œì‹œê¸€ë“¤ì˜ ë°ì´í„° - by 1-blue */
  const { data, hasNextPage, fetchNextPage } = usePosts({
    take: 10,
    lastIdx: postIdx ? +postIdx : undefined,
  });

  return (
    <InfiniteScrollContainer hasMore={hasNextPage} fetchMore={fetchNextPage}>
      <StyledPost>
        {data?.pages.map((page) =>
          page.posts?.map((post) => (
            <li key={post.idx}>
              <PostHeader user={post.user} postIdx={post.idx} />
              <PostPhotos photos={splitPhotoURL(post.photos)} />
              <PostFooter contents={post.contents} />
            </li>
          ))
        )}
      </StyledPost>
    </InfiniteScrollContainer>
  );
};

export default Post;
```

## 2ï¸âƒ£ IntersectionObserver APIë¥¼ í™œìš©í•œ HOC
> [`IntersectionObserver API`](/posts/Intersection-Observer-API){:target="_blank"}ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ í•´ë‹¹ ë§í¬ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”!<br />
{:.prompt-info}

`IntersectionObserver API`ë¥¼ ì´ìš©í•´ì„œ ìš”ì†Œë¥¼ ê°ì‹œí•˜ê³  í•´ë‹¹ ìš”ì†Œê°€ ë·°í¬íŠ¸ì— ë“¤ì–´ì˜¤ë©´ `props`ë¡œ ë°›ì€ ê²Œì‹œê¸€ë“¤ íŒ¨ì¹˜ í•¨ìˆ˜(`fetchMore()`)ë¥¼ ì‹¤í–‰í•˜ëŠ” êµ¬ì¡°ë¡œ ë™ì‘í•©ë‹ˆë‹¤.<br />
í•˜ì§€ë§Œ ì–¸ì  ê°€ëŠ” ë°ì´í„°ê°€ ì—†ì„ ê²ƒì´ê¸° ë•Œë¬¸ì— `hasMore`ì„ ì´ìš©í•´ì„œ ë” íŒ¨ì¹˜í•  ìˆ˜ ìˆëŠ”ì§€ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•©ë‹ˆë‹¤.<br />

ë”°ë¼ì„œ í•´ë‹¹ `HOC`ë¥¼ ê°ì‹¸ì£¼ê¸°ë§Œ í•˜ë©´ ìµœí•˜ë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤ì„ ë‚´ë ¸ì„ ì‹œì ì— ë‹¤ì‹œ ê²Œì‹œê¸€ë“¤ì„ íŒ¨ì¹˜í•˜ê²Œ ë©ë‹ˆë‹¤.<br /> 

+ [`/src/components/common/InfiniteScrollContainer/index.tsx`](https://github.com/1-blue/blegram/tree/master/src/components/common/InfiniteScrollContainer/index.tsx){:target="_blank"}

```tsx
import { useCallback, useEffect, useRef } from "react";

// type
import type { PropsWithChildren } from "react";
interface Props {
  hasMore?: boolean;
  fetchMore: () => void;
}

/** 2023/04/11 - "IntersectionObserver"ì˜ ì˜µì…˜ë“¤ - by 1-blue */
const options: IntersectionObserverInit = {
  threshold: 0.1,
};

/** 2023/04/11 - ë¬´í•œ ìŠ¤í¬ë¡¤ë§ ì ìš© ( using "IntersectionObserver" ) - by 1-blue */
const InfiniteScrollContainer: React.FC<PropsWithChildren<Props>> = ({
  hasMore,
  fetchMore,
  children,
}) => {
  /** 2023/04/11 - ê°ì‹œí•  ìš”ì†Œì˜ ref - by 1-blue */
  const observerRef = useRef<HTMLDivElement>(null);

  /** 2023/04/11 - ìƒë‹¨ìœ¼ë¡œ ë·°í¬íŠ¸ ë‚´ì— ê°ì‹œí•˜ëŠ” íƒœê·¸ê°€ ë“¤ì–´ì™”ë‹¤ë©´ íŒ¨ì¹˜ - by 1-blue */
  const onScroll: IntersectionObserverCallback = useCallback(
    (entries) => {
      if (!entries[0].isIntersecting) return;

      fetchMore();
    },
    [fetchMore]
  );
  /** 2023/04/11 - ìƒë‹¨ observer ë“±ë¡ ( í•´ë‹¹ íƒœê·¸ê°€ ë·°í¬íŠ¸ì— ë“¤ì–´ì˜¤ë©´ ê²Œì‹œê¸€ ì¶”ê°€ íŒ¨ì¹˜ ì‹¤í–‰ ) - by 1-blue */
  useEffect(() => {
    if (!observerRef.current) return;

    // ì½œë°±í•¨ìˆ˜ì™€ ì˜µì…˜ê°’ ì§€ì •
    let observer = new IntersectionObserver(onScroll, options);

    // íŠ¹ì • ìš”ì†Œ ê°ì‹œ ì‹œì‘
    observer.observe(observerRef.current);

    // ë” ê°€ì ¸ì˜¬ ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ íŒ¨ì¹˜ ì¤‘ì§€
    if (!hasMore) observer.unobserve(observerRef.current);

    // ê°ì‹œ ì¢…ë£Œ
    return () => observer.disconnect();
  }, [observerRef, onScroll, hasMore]);

  return (
    <>
      {children}
      <div ref={observerRef} />
    </>
  );
};

export default InfiniteScrollContainer;
```

# ğŸ“¥ BE

## 0ï¸âƒ£ ê²Œì‹œê¸€ë“¤ ê°€ì ¸ì˜¤ê¸° ì—”ë“œí¬ì¸íŠ¸
> ìì„¸í•œ ë¶€ë¶„ì€ `prisma`ì˜ [`pagination`](https://www.prisma.io/docs/concepts/components/prisma-client/pagination){:target="_blank"}ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”!<br />
{:.prompt-tip}

`prisma`ì˜ `take`, `skip`, `cursor`ë¥¼ ì´ìš©í•´ì„œ ê²Œì‹œê¸€ë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.<br />
( `cursor`ë¥¼ ì´ìš©í•´ì„œ íŠ¹ì • ì‹ë³„ìë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. )<br />

ë‚˜ë¨¸ì§€ `include` ë¶€ë¶„ì€ í”„ë¡ íŠ¸ì—ì„œ í•„ìš”í•œ ë°ì´í„°ë¥¼ ë‚´ë ¤ì¤˜ì•¼í•˜ê¸° ë•Œë¬¸ì— ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ëŠ” ë¶€ë¶„ì´ë¼ í•´ë‹¹ ë¡œì§ì˜ íë¦„ì—ëŠ” ì˜í–¥ì„ ë¼ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br />

+ [`/src/pages/api/posts.ts`](https://github.com/1-blue/blegram/tree/master/src/pages/api/posts.ts){:target="_blank"}

```ts
// prisma
import { prisma } from "@src/prisma";

// lib
import withAuthMiddleware from "@src/lib/middleware";

// type
import type { NextApiHandler } from "next";
import type { ApiFetchPostsResponse } from "@src/types/api";

/** 2023/04/08 - ê²Œì‹œê¸€ë“¤ ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ - by 1-blue */
const handler: NextApiHandler<ApiFetchPostsResponse> = async (req, res) => {
  try {
    // ëª¨ë“  ê²Œì‹œê¸€ë“¤ ê°€ì ¸ì˜¤ê¸° ìš”ì²­
    if (req.method === "GET") {
      const take = +(req.query.take as string);
      const lastIdx = +(req.query.lastIdx as string);

      const posts = await prisma.post.findMany({
        where: {},
        take,
        skip: lastIdx === -1 ? 0 : 1,
        ...(lastIdx !== -1 && { cursor: { idx: lastIdx } }),
        orderBy: { createdAt: "desc" },
        include: {
          user: {
            select: {
              idx: true,
              avatar: true,
              nickname: true,
            },
          },
          comments: {},
          postLiker: {
            select: {
              postLiker: {
                select: {
                  idx: true,
                  avatar: true,
                  nickname: true,
                },
              },
            },
          },
          _count: {
            select: {
              comments: true,
              postLiker: true,
            },
          },
        },
      });

      return res.status(200).json({
        message: `ìµœì‹  ê²Œì‹œê¸€ ${posts.length}ê°œë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`,
        posts,
      });
    }
  } catch (error) {
    console.error("/api/user error >> ", error);

    return res.status(500).json({
      message: "ì„œë²„ì¸¡ ë¬¸ì œì…ë‹ˆë‹¤.\nì ì‹œí›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!",
    });
  }
};

export default withAuthMiddleware({
  methods: ["GET"],
  handler,
  isAuth: false,
});
```

# ğŸ˜¢ ì‹¤íŒ¨í•œ ì´ì•¼ê¸°
`react.query`ì˜ `useInfiniteQuery()`ì™€ `prisma`ë¥¼ ì´ìš©í•´ì„œ ì–‘ë°©í–¥ ìŠ¤í¬ë¡¤ì„ êµ¬í˜„í•˜ë ¤ê³  í–ˆìŠµë‹ˆë‹¤.<br />
í•˜ì§€ë§Œ `useInfiniteQuery()`ì„ ì´ìš©í•œ ì–‘ë°©í–¥ì„ êµ¬í˜„í•  ë•Œ ìœ„ìª½ìœ¼ë¡œ íŒ¨ì¹˜ì¸ì§€ ì•„ë˜ìª½ìœ¼ë¡œ íŒ¨ì¹˜ì¸ì§€ íŒŒì•…í•˜ê¸° í˜ë“¤ì—ˆê³ , íŒŒì•…í–ˆë‹¤ê³  í•˜ë”ë¼ë„ [`prisma`ì˜ `-take`](https://www.prisma.io/docs/concepts/components/prisma-client/pagination#example-paging-backwards-with-cursor-based-pagination){:target="_blank"}ë¡œëŠ” ì–´ë–»ê²Œ êµ¬í˜„í•´ì•¼í• ì§€ ëª°ë¼ì„œ ê³„ì† ì‹œë„í•˜ë‹¤ê°€ í¬ê¸°í–ˆìŠµë‹ˆë‹¤.<br />

ë§Œì•½ ë°ì´í„°ê°€ 1 ~ 10ê¹Œì§€ ìˆê³  5ë¥¼ `cursor`ë¡œ ì‹œì‘í•œë‹¤ë©´ `take: -3`ì„ ê°€ì ¸ì˜¤ë„ë¡ í•œë‹¤ë©´ `2, 3, 4`ë¥¼ ê°€ì ¸ì˜¬ê±°ë¼ê³  ìƒê°í–ˆì§€ë§Œ, `8, 7, 6`ìœ¼ë¡œ ì—­ìˆœìœ¼ë¡œ ê°€ì ¸ì˜¤ê²Œ ë˜ì–´ì„œ ë­ê°€ ë¬¸ì œì¸ì§€ ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë§ëŠ”ì§€ í˜¼ë™ì´ ì™€ì„œ í•µì‹¬ì ì¸ ê¸°ëŠ¥ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì¼ë‹¨ì€ ë„˜ì–´ê°”ìŠµë‹ˆë‹¤.<br />
ì£¼ìš” ê¸°ëŠ¥ë“¤ì„ ë¨¼ì € êµ¬í˜„í•˜ê³  ë‚˜ì„œ ì¶”ê°€ì ìœ¼ë¡œ êµ¬í˜„í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.<br />

# ğŸ“® ë ˆí¼ëŸ°ìŠ¤
1. [prisma - pagination](https://www.prisma.io/docs/concepts/components/prisma-client/pagination){:target="_blank"}

1. [1-blue - IntersectionObserver API](https://1-blue.github.io/posts/Intersection-Observer-API){:target="_blank"}