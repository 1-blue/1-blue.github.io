---
layout: post
title: blegram(1) - íšŒì›ê°€ì… êµ¬í˜„ ( Prisma )
author: admin
date: 2023-03-27 21:27:00 +900
lastmod: 2023-03-27 21:27:00 +900
sitemap:
  changefreq: monthly
  priority: 0.5
categories: [Project, blegram]
tags: [blegram, Next.js, TypeScript, prisma, signup]
---

> í•´ë‹¹ í”„ë¡œì íŠ¸ëŠ” `Next.js` + `TypeScript`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“œëŠ” ì¸ìŠ¤íƒ€ê·¸ë¨ í´ë¡  ê°œì¸ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.<br />
{:.prompt-info}

# ğŸ“¤ FE
## 0ï¸âƒ£ react-hook-form
íšŒì›ê°€ì…ë§Œì´ ì•„ë‹ˆë¼ í•´ë‹¹ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” `form`ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ì„œ ì„ íƒí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.<br />

`form`ì—ì„œ ì‚¬ìš©í•  íƒ€ì…ë§Œ ì •ì˜í•˜ê³  ì •í•´ì§„ ë°©ì‹ëŒ€ë¡œ ì†ì„±ë§Œ ë„£ì–´ì¤€ë‹¤ë©´, `form`ì— ëŒ€í•œ ë°ì´í„° ê´€ë¦¬, ê°ì‹œ, ìœ íš¨ì„± ê²€ì‚¬ ë“±ì˜ ë§ì€ ê¸°ëŠ¥ë“¤ì„ ì‰½ê²Œ ì‚¬ìš©í•˜ë„ë¡ ë„ì™€ì£¼ê¸° ë•Œë¬¸ì— ìœ ìš©í•˜ê²Œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br />
í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ì–´ë–»ê²Œ í™œìš©í–ˆëŠ”ì§€ì— ëŒ€í•´ì„œë§Œ ì‘ì„±í•˜ê³  ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ”ì§€ì— ëŒ€í•´ì„œ ê¶ê¸ˆí•˜ë‹¤ë©´ [ê³µì‹ ë¬¸ì„œ](https://react-hook-form.com/){:target="_blank"}ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”!<br />

### 1. ì„¤ì¹˜
```bash
npm i react-hook-form
```

### 2. êµ¬í˜„í•œ ì½”ë“œ
êµ¬í˜„ì— ì‚¬ìš©í•œ ëª¨ë“  ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸°ì—ëŠ” ë„ˆë¬´ ë§ì•„ì„œ ìƒì„¸í•œ ì½”ë“œëŠ” ê¹ƒí—™ ë§í¬ë¡œ ëŒ€ì²´í•˜ê² ìŠµë‹ˆë‹¤.<br />

ëŒ€ë¶€ë¶„ì˜ ê¸°ëŠ¥ì€ `react-hook-form`ì—ì„œ ì œê³µí•´ì£¼ëŠ” ê¸°ëŠ¥ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í–ˆê³ , ì´ë²ˆì— ì‚¬ìš©í•  í˜•íƒœì— ë”°ë¼ì„œ ì»¤ìŠ¤í…€ ì»´í¬ë„ŒíŠ¸ë¥¼ ì œì‘í•´ì„œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br />

`<input />`ì„ ì‚¬ìš©í•  ë•Œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥ë“¤ì„ ëª¨ë‘ ë¬¶ì–´ì„œ í•˜ë‚˜ì˜ ì»´í¬ë„ŒíŠ¸ë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.<br />
1. `label`: `id` ì†ì„±ì— ë§ê²Œ ë¼ë²¨ì„ ì¢Œì¸¡ ìƒë‹¨ì— ì‘ê²Œ ìƒì„±
1. `subText`: ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•˜ì§€ ëª»í•˜ë©´ ì¢Œì¸¡ í•˜ë‹¨ì— ì‘ê²Œ ì—ëŸ¬ ë¬¸êµ¬ ìƒì„± ( `react-hook-form`ì˜ `error` ê°ì²´ ì‚¬ìš© )

`register()`ë¥¼ ì´ìš©í•˜ë©´ `ref`ë¥¼ ì „ë‹¬í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— `React.forwardRef()`ë¥¼ ì‚¬ìš©í–ˆê³ , ê·¸ì— ë§ëŠ” `props` íƒ€ì…ì„ ì§€ì •í•´ì¤¬ìŠµë‹ˆë‹¤.<br />

+ [`Input.tsx`](https://github.com/1-blue/blegram/tree/master/src/components/common/FormToolkit/Input/index.tsx){:target="_blank"}

```tsx
import React from "react";

// style
import StyledInput from "./style";

// type
import type { UseFormRegister } from "react-hook-form";
import type { LogInForm, SignUpForm } from "@src/types";

interface Props {
  id: string;
  type: React.HTMLInputTypeAttribute;
  placeholder: string;
  subText?: string;
  [index: string]: any;
}

/** 2023/03/25 - Input ì»´í¬ë„ŒíŠ¸ - by 1-blue */
const Input = React.forwardRef<
  HTMLInputElement,
  Props &
    (
      | ReturnType<UseFormRegister<SignUpForm>>
      | ReturnType<UseFormRegister<LogInForm>>
    )
>(({ id, type, placeholder, subText, ...props }, ref) => (
  <StyledInput>
    <label htmlFor={id}>{id}</label>
    <input
      id={id}
      type={type}
      placeholder={placeholder}
      autoComplete="current-password"
      {...props}
      ref={ref}
    />
    <span>{subText}</span>
  </StyledInput>
));

Input.displayName = "Input";

export default Input;
```

+ [`ì‚¬ìš© ì˜ˆì‹œ`](https://github.com/1-blue/blegram/tree/master/src/app/login/page.tsx){:target="_blank"}

```tsx
import { useForm } from "react-hook-form";

// style
import StyledLogInForm from "./style";

// type
import type { LogInForm } from "@src/types";

/** 2023/03/24 - ë¡œê·¸ì¸ í˜ì´ì§€ - by 1-blue */
const LogInPage = () => {
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LogInForm>();

  /** 2023/03/25 - ë¡œê·¸ì¸ ìˆ˜í–‰ í•¸ë“¤ëŸ¬ - by 1-blue */
  const onLogIn: React.FormEventHandler<HTMLFormElement> = handleSubmit(
    useCallback(
      async (body) => {
        try {
          // ... ë¡œê·¸ì¸ ìš”ì²­ ì²˜ë¦¬
        } catch (error) {
          console.error(error);
        }
      },
      [router]
    )
  );

  return (
    <StyledLogInForm onSubmit={onLogIn}>
      {/* ë‚˜ë¨¸ì§€ ìƒëµ ... */}

      <FormToolkit.Input
        id="id"
        type="text"
        placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
        subText={errors.id?.message}
        {...register("id", {
          required: "ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!",
          pattern: {
            value: /(?=.*\d)(?=.*[a-zA-ZS]).{6,16}/,
            message: "ìˆ«ìì™€ ì˜ì–´ê°€ ìµœì†Œ í•œ ê¸€ì ì´ìƒ í¬í•¨ë˜ê³ , ìµœì†Œ 6ìë¦¬, ìµœëŒ€ 16ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤!"
          },
        })}
      />
      <FormToolkit.Input
        id="password"
        type="password"
        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
        subText={errors.password?.message}
        {...register("password", { required: "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!" })}
      />
      
      {/* ë‚˜ë¨¸ì§€ ìƒëµ ... */}
    </StyledLogInForm>
  );
};

export default LogInPage;
```

# ğŸ“¥ BE
## 0ï¸âƒ£ prisma
ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‰½ê²Œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œ `ORM` ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.<br />

ì„¤ì¹˜ì™€ ì‚¬ìš©ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ë‚´ìš©ì€ [prisma](/posts/prisma){:target="_blank"}ë¥¼ ì°¸ê³ í•´ì£¼ì‹œê³  í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ê¸°ë³¸ì ì¸ ë‚´ìš©ì„ ì œì™¸í•˜ê³  ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.<br />

ë˜í•œ ì•„ì§ íšŒì›ê°€ì… ë¶€ë¶„ì´ë¼ `User`ì— ëŒ€í•œ ëª¨ë¸ ì •ì˜ë§Œ ì‘ì„±í•  ê²ƒì´ë¼ ë‚´ìš©ì´ ë³„ë¡œ ì—†ìŠµë‹ˆë‹¤.<br />
ê³„ì† ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ë©´ì„œ ë‹¤ìŒ í¬ìŠ¤íŠ¸ë“¤ì„ í†µí•´ì„œ ë‹¤ë¥¸ ëª¨ë¸ì˜ ì •ì˜ì™€ ëª¨ë¸ê°„ì˜ ê´€ê³„ì— ëŒ€í•´ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.<br />

### 1. ì„¤ì¹˜
```bash
npm i prisma @prisma/client
```

### 2. User ëª¨ë¸
ëŒ€ë¶€ë¶„ ë¬¸ìì—´ë“¤ì€ í•´ë‹¹ ë¬¸ìì—´ì„ ì…ë ¥ë°›ì„ ë•Œ ê¸€ììˆ˜ ì œí•œì„ ê±¸ì—ˆê¸° ë•Œë¬¸ì— ê·¸ ê¸€ììˆ˜ë§Œí¼ì˜ í¬ê¸°ë§Œ ì°¨ì§€í•˜ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.<br />
`password`ëŠ” í•´ì‹±ì„ í†µí•´ì„œ ê¸¸ì´ê°€ ëŠ˜ì–´ë‚˜ê¸° ë•Œë¬¸ì— ë” ë§ì€ ê³µê°„ì„ í• ë‹¹í–ˆê³ , `avatar`ë„ `S3`ì— ë„£ìœ¼ë©´ì„œ `URL`ì´ ì¶”ê°€ë˜ê³  ì¤‘ë³µë˜ì§€ ì•Šê²Œ í•˜ê¸° ìœ„í•´ ì‹œê°„ ê°’ì„ ë¶€ì—¬í•  ê²ƒì´ê¸° ë•Œë¬¸ì— ë” ë§ì€ ê³µê°„ì„ í• ë‹¹í–ˆìŠµë‹ˆë‹¤.<br />
ë‚˜ë¨¸ì§€ëŠ” íšŒì›ê°€ì…ì— í•„ìš”í•œ ë°ì´í„°ë“¤ì— ëŒ€í•´ ì •ì˜ë¥¼ í–ˆìŠµë‹ˆë‹¤.<br />
( `idx`ëŠ” í•´ë‹¹ ìœ ì €ë¥¼ ì‹ë³„í•˜ëŠ” ê³ ìœ ì˜ ì‹ë³„ì )<br />

```text
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  idx Int @id @unique @default(autoincrement())
  id String @unique @db.VarChar(16)
  password String @db.VarChar(100)
  name String @unique @db.VarChar(20)
  email String @unique @db.VarChar(30)
  phone String @unique @db.VarChar(11)
  birthday String @db.VarChar(8)
  introduction String @db.VarChar(100)
  avatar String? @db.VarChar(160)
}
```

### 3. íƒ€ì… í™œìš©
`prisma`ë¥¼ ì´ìš©í•´ì„œ ëª¨ë¸ì„ ì •ì˜í•˜ê³  `npx prisma db push` or `npx prisma migrate dev` ê°™ì€ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ì„œ `DB`ì— ë™ê¸°í™”í•˜ë©´ í•´ë‹¹ ëª¨ë¸ì— ëŒ€í•œ íƒ€ì…ì„ ë§Œë“¤ì–´ì„œ ì œê³µí•´ì¤ë‹ˆë‹¤.<br />

ìœ„ì˜ `User` ëª¨ë¸ì„ ì˜ˆì‹œë¡œ ë§Œë“¤ì–´ì¤€ íƒ€ì…ì„ ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br />
ì´ëŒ€ë¡œ ê·¸ëƒ¥ ê°€ì ¸ì™€ì„œ ì‚¬ìš©í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì— ë§¤ìš° í¸í•©ë‹ˆë‹¤.<br />

```ts
import type { User } from "@prisma/client";

/**
 * Model User
 * 
 */
export type User = {
  idx: number
  id: string
  password: string
  name: string
  email: string
  phone: string
  birthday: string
  introduction: string
  avatar: string | null
}
```

í•˜ì§€ë§Œ í˜¹ì‹œ ê¸°ì¡´ íƒ€ì…ì—ì„œ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ í•„ìš”í•˜ë©´ ìƒˆë¡œìš´ íƒ€ì…ì„ ì•„ì˜ˆ ìƒˆë¡œ ì‘ì„±í•˜ê¸° ë³´ë‹¤ëŠ” ìœ í‹¸ë¦¬í‹° íƒ€ì…ì„ ì´ìš©í•´ì„œ í•´ë‹¹ íƒ€ì…ì— ì˜ì¡´í•˜ëŠ” íƒ€ì…ìœ¼ë¡œ ì‘ì„±í•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤.<br />

```ts
export type SimpleUser = Pick<User, "idx" | "name" | "avatar">;
```

# ğŸ•¯ï¸ íšŒì›ê°€ì… ë¡œì§
íšŒì›ê°€ì… ë¡œì§ì€ ë‹¤ë¥¸ ê²ƒë“¤ì— ë¹„í•´ì„œ ë‹¨ìˆœí•©ë‹ˆë‹¤.<br />
íšŒì›ê°€ì…í•  ìœ ì €ì˜ ì •ë³´ë¥¼ ë°›ì•„ì„œ ì¤‘ë³µ ë¶ˆê°€ëŠ¥í•œ ì •ë³´ëŠ” `DB`ì—ì„œ í™•ì¸ í›„ ì¤‘ë³µë˜ë©´ ì¤‘ë³µë˜ì—ˆë‹¤ë©´ `409`ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.<br />
ë§Œì•½ ì¤‘ë³µë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìœ ì €ë¥¼ ìƒì„±í•˜ê³  `201`ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.<br />

`prisma`ë¥¼ ì´ìš©í•´ì„œ ì¤‘ë³µ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , ë™ì‹œì— ì²˜ë¦¬í•´ë„ ë˜ê¸° ë•Œë¬¸ì— [`Promise.all()`](/posts/ë¹„ë™ê¸°-ì½œë°±-í”„ë¡œë¯¸ìŠ¤-async-await/#0-promisealliterable){:target="_blank"}ì„ ì´ìš©í•´ì„œ ë³‘ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬í•´ì„œ ì‹œê°„ì„ ìµœì†Œí™”í–ˆìŠµë‹ˆë‹¤.<br />

ìƒê°í•´ë³´ë©´ íŠ¹ì • ë°ì´í„°ì— ëŒ€í•œ ì¤‘ë³µì„ í™•ì¸í•˜ëŠ” ê²ƒì´ë¼ í•œ ë²ˆì˜ í™•ì¸ìœ¼ë¡œ ì²´í¬í•˜ë©´ ë°˜ë³µì„ ì¤„ì¼ ìˆ˜ ìˆì„ ê²ƒ ê°™ì€ë° ì •í™•í•œ ë°©ë²•ì„ ëª» ì°¾ì•„ì„œ ì¼ë‹¨ ê°ê° íƒìƒ‰í•˜ë©´ì„œ ì¤‘ë³µëœ ë°ì´í„°ê°€ ì°¾ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤... ğŸ¥²
ë‚˜ì¤‘ì— ì¢‹ì€ ë°©ë²•ì„ ì°¾ìœ¼ë©´ ë‹¤ì‹œ ê¸°ë¡í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.<br />

+ [`/src/lib/auth.ts`](https://github.com/1-blue/blegram/tree/master/src/lib/auth.ts){:target="_blank"}

```ts
import bcrypt from "bcrypt";

interface HashingHandler {
  (password: string, saltRound?: number): Promise<string>;
}
/** 2023/03/25 - ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” - by 1-blue */
export const hashing: HashingHandler = async (password, saltRound = 10) => {
  // í•´ì‹±í•  ë•Œ ì‚¬ìš©í•  ê°’ ìƒì„±
  const salt = await bcrypt.genSalt(saltRound);

  // ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
  const hashedPassword = await bcrypt.hash(password, salt); // password í•´ì‰¬í™” ì™„ì„±

  // í•´ì‹±í•œ ë¹„ë°€ë²ˆí˜¸ ë°˜í™˜
  return hashedPassword;
};
```

+ [`/src/pages/signup.ts`](https://github.com/1-blue/blegram/tree/master/src/pages/signup.ts){:target="_blank"}

```tsx
// prisma
import { prisma } from "@src/prisma";

// lib
import withAuthMiddleware from "@src/lib/middleware";
import { hashing } from "@src/lib/auth";

// type
import type { NextApiHandler } from "next";
import type { SignUpForm } from "@src/types";
import type { ApiSignUpResponse } from "@src/types/api";
type SignUpBody = SignUpForm;

/** 2023/03/26 - íšŒì›ê°€ì… - by 1-blue */
const handler: NextApiHandler<ApiSignUpResponse> = async (req, res) => {
  try {
    // íšŒì›ê°€ì…
    if (req.method === "POST") {
      // íšŒì›ê°€ì…í•˜ëŠ” ìœ ì €ì˜ ë°ì´í„°
      const { password, ...body } = req.body as SignUpBody;

      // ì•„ì´ë””, ì´ë¦„, ì´ë©”ì¼, íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ ê²€ì‚¬ ( DB )
      const exUserList = await Promise.all([
        prisma.user.findUnique({ where: { id: body.id } }),
        prisma.user.findUnique({ where: { name: body.name } }),
        prisma.user.findUnique({ where: { email: body.email } }),
        prisma.user.findUnique({ where: { phone: body.phone } }),
      ]);

      // ì•„ì´ë””, ì´ë¦„, ì´ë©”ì¼, íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ ê²€ì‚¬ ( ì‘ë‹µ )
      if (exUserList[0])
        return res.status(409).json({ message: "ì•„ì´ë””ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤." });
      if (exUserList[1])
        return res.status(409).json({ message: "ì´ë¦„ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤." });
      if (exUserList[2])
        return res.status(409).json({ message: "ì´ë©”ì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤." });
      if (exUserList[3])
        return res.status(409).json({ message: "í°ë²ˆí˜¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤." });

      // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”
      const hashedPassword = await hashing(password);

      // ìœ ì € ìƒì„±
      await prisma.user.create({ data: { ...body, password: hashedPassword } });

      return res.status(201).json({
        message: "íšŒì›ê°€ì…ì„ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ë©ë‹ˆë‹¤.",
      });
    }
  } catch (error) {
    console.error("/api/signup error >> ", error);

    return res
      .status(500)
      .json({ message: "ì„œë²„ì¸¡ ë¬¸ì œì…ë‹ˆë‹¤.\nì ì‹œí›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!" });
  }
};

export default withAuthMiddleware({
  methods: ["POST"],
  handler,
  isAuth: false,
});
```

# ğŸ“® ë ˆí¼ëŸ°ìŠ¤
1. [react-hook-form](https://react-hook-form.com/){:target="_blank"}
1. [prisma](https://www.prisma.io/){:target="_blank"}

1. [1-blue - prisma](/posts/prisma/){:target="_blank"}
1. [1-blue - Promise.all()](/posts/ë¹„ë™ê¸°-ì½œë°±-í”„ë¡œë¯¸ìŠ¤-async-await/#0-promisealliterable){:target="_blank"}